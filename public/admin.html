<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - AI ç²‰ç¬”ç”»ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        chalk: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            900: '#111827',
                        },
                        board: '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f0f10;
            color: #e5e7eb;
        }
        .chalk-effect {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .backdrop-blur-custom {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hover-scale {
            transition: transform 0.3s ease;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }
        /* ç™»å½•é¡µé¢èƒŒæ™¯åŠ¨ç”» */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
        /* ç®¡ç†æ ‡ç­¾é¡µæ ·å¼ */
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .config-card {
            background: rgba(30, 30, 35, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.5);
            transition: all 0.3s ease;
        }
        .config-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative">
    
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-tr from-indigo-500/10 to-pink-500/10 rounded-full blur-3xl"></div>
    </div>

    <!-- ç™»å½•å®¹å™¨ -->
    <div id="loginContainer" class="w-full max-w-md relative z-10">
        <div class="bg-[#18181b] border border-gray-800 rounded-2xl shadow-2xl p-8 fade-in">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 text-white mb-4 float-animation">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2 chalk-effect">ç®¡ç†åå°</h1>
                <p class="text-gray-500 text-sm">AI ç²‰ç¬”ç”»ç”Ÿæˆå™¨é…ç½®ä¸­å¿ƒ</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required
                        class="w-full bg-[#18181b] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">å¯†ç </label>
                    <input type="password" id="password" name="password" required
                        class="w-full bg-[#18181b] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                        placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>

                <div id="loginError" class="hidden text-red-400 text-sm p-3 rounded bg-red-900/30 border border-red-800/50"></div>

                <div id="defaultWarning" class="hidden p-3 rounded bg-yellow-900/30 border border-yellow-800/50">
                    <p class="text-yellow-300 text-sm mb-2">âš ï¸ å®‰å…¨æé†’</p>
                    <p class="text-yellow-200 text-xs">æ‚¨æ­£åœ¨ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼Œå»ºè®®ç«‹å³ä¿®æ”¹ä¸ºè‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç ä»¥ç¡®ä¿å®‰å…¨ã€‚</p>
                </div>

                <button type="submit" id="loginBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 hover-scale">
                    <span>ç™»å½•ç®¡ç†åå°</span>
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-gray-700 text-center">
                <p class="text-gray-500 text-xs">é»˜è®¤è´¦å·: admin / admin</p>
                <p class="text-gray-600 text-xs mt-1">é¦–æ¬¡ç™»å½•åè¯·åŠæ—¶ä¿®æ”¹</p>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†ç•Œé¢å®¹å™¨ -->
    <div id="adminContainer" class="hidden w-full max-w-6xl relative z-10">
        <div class="bg-[#18181b] border border-gray-800 rounded-2xl shadow-2xl overflow-hidden fade-in">
            
            <!-- å¤´éƒ¨å¯¼èˆª -->
            <div class="p-6 border-b border-gray-800">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-white chalk-effect">é…ç½®ç®¡ç†</h1>
                        <p class="text-gray-500 text-sm mt-1">AI ç²‰ç¬”ç”»ç”Ÿæˆå™¨ â€¢ ç®¡ç†ä¸­å¿ƒ</p>
                    </div>
                    <button id="logoutBtn" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2 rounded-lg transition border border-red-800/50 hover:border-red-700">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        é€€å‡ºç™»å½•
                    </button>
                </div>

                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="flex space-x-2">
                    <button class="tab-btn tab-active px-4 py-2 rounded-lg font-medium transition" data-tab="gallery">
                        ğŸ“¸ å›¾ç‰‡ç®¡ç†
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg font-medium bg-gray-800 text-gray-300 hover:bg-gray-700 transition" data-tab="api">
                        ğŸ”Œ APIé…ç½®
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg font-medium bg-gray-800 text-gray-300 hover:bg-gray-700 transition" data-tab="prompts">
                        âœï¸ æç¤ºè¯ç®¡ç†
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg font-medium bg-gray-800 text-gray-300 hover:bg-gray-700 transition" data-tab="settings">
                        âš™ï¸ åŸºç¡€è®¾ç½®
                    </button>
                </div>
            </div>

            <!-- ç®¡ç†å†…å®¹åŒº -->
            <div class="p-6">
                <!-- å›¾ç‰‡ç®¡ç† -->
                <div id="galleryTab" class="tab-content">
                    <div class="config-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            è·‘é©¬ç¯ç¤ºä¾‹å›¾ç‰‡ç®¡ç†
                        </h3>
                        
                        <div class="mb-4">
                            <div class="flex space-x-2">
                                <input type="url" id="newImageUrl" placeholder="è¯·è¾“å…¥å›¾ç‰‡ç½‘å€ (https://...)" 
                                    class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="addImageBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                    æ·»åŠ å›¾ç‰‡
                                </button>
                            </div>
                        </div>

                        <div id="imageList" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- å›¾ç‰‡åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div class="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-800/50">
                            <p class="text-blue-300 text-sm">
                                ğŸ’¡ æç¤ºï¼šæ·»åŠ æ–°å›¾ç‰‡åï¼Œç”¨æˆ·è®¿é—®é¡µé¢æ—¶ä¼šéšæœºå±•ç¤ºè¿™äº›ç¤ºä¾‹ä½œå“ï¼Œä¿æŒå†…å®¹æ–°é²œæ„Ÿã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <!-- APIé…ç½® -->
                <div id="apiTab" class="tab-content hidden">
                    <div class="config-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            ç¬¬ä¸‰æ–¹APIé…ç½®
                        </h3>
                        
                        <div class="mb-6">
                            <div class="p-4 bg-green-900/20 rounded-lg border border-green-800/50">
                                <h4 class="text-green-400 font-medium mb-2">âœ‹ å½“å‰ä½¿ç”¨ç¯å¢ƒå˜é‡ API</h4>
                                <p class="text-green-300 text-sm">ç³»ç»Ÿæ­£åœ¨ç›´æ¥ä½¿ç”¨ Cloudflare Pages ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ API å¯†é’¥ã€‚</p>
                                <p class="text-gray-400 text-xs mt-2">å¦‚éœ€é…ç½®ç¬¬ä¸‰æ–¹ APIï¼Œè¯·åœ¨ Cloudflare Dashboard â†’ Pages â†’ Settings â†’ Environment variables ä¸­è®¾ç½® GEMINI_API_KEY</p>
                            </div>
                        </div>

                        <div class="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-800/50">
                            <p class="text-blue-300 text-sm">
                                ğŸ’¡ é…ç½®å¤šä¸ª API å¯†é’¥å¯ä»¥é¿å…å•ä¸ª API è¾¾åˆ°é€Ÿç‡é™åˆ¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•å¯ç”¨çš„ APIã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯ç®¡ç† -->
                <div id="promptsTab" class="tab-content hidden">
                    <div class="config-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            é£æ ¼æç¤ºè¯ç®¡ç†
                        </h3>

                        <div class="mb-6">
                            <div class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" id="promptName" placeholder="æç¤ºè¯åç§° (å¦‚: æ°´å½©ç”»é£)" 
                                        class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <input type="text" id="promptKey" placeholder="æç¤ºè¯é”®å€¼ (å¦‚: watercolor)" 
                                        class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button id="addPromptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                        æ·»åŠ æç¤ºè¯
                                    </button>
                                </div>
                                <div>
                                    <label for="promptContent" class="block text-sm font-medium text-gray-300 mb-2">å®Œæ•´æç¤ºè¯å†…å®¹ (å¯é€‰)</label>
                                    <textarea id="promptContent" placeholder="è¾“å…¥å®Œæ•´çš„æç¤ºè¯å†…å®¹ï¼Œç•™ç©ºå°†ä½¿ç”¨å†…ç½®æ¨¡æ¿ã€‚æ”¯æŒå˜é‡ ${name}" 
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 h-32 resize-vertical"
                                        rows="4"></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="promptList" class="space-y-3">
                            <!-- æç¤ºè¯åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div class="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-800/50">
                            <p class="text-blue-300 text-sm">
                                ğŸ’¡ æ–°å¢æç¤ºè¯ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å‰ç«¯é€‰æ‹©èœå•ï¼Œæ”¯æŒå®Œæ•´çš„è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <!-- åŸºç¡€è®¾ç½® -->
                <div id="settingsTab" class="tab-content hidden">
                    <div class="config-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            åŸºç¡€è®¾ç½®
                        </h3>

                        <!-- ç™»å½•å‡­è¯ -->
                        <div class="mb-6">
                            <h4 class="text-md font-medium text-gray-300 mb-3">ç™»å½•å‡­è¯å®å</h4>
                            <div class="p-4 bg-yellow-900/20 rounded-lg border border-yellow-800/50 mb-4">
                                <p class="text-yellow-300 text-sm mb-2">ğŸ” å½“å‰å‡­è¯ä¿¡æ¯</p>
                                <p class="text-yellow-200 text-xs">
                                    ç”¨æˆ·åï¼š<span id="currentCredentials" class="font-mono">åŠ è½½ä¸­...</span>
                                </p>
                                <p class="text-yellow-200 text-xs mt-1">
                                    ä¿®æ”¹å‡­è¯åä¼šè‡ªåŠ¨ä¿å­˜å¹¶è¦æ±‚é‡æ–°ç™»å½•
                                </p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="newUsername" placeholder="æ–°ç”¨æˆ·å" 
                                    class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="password" id="newPassword" placeholder="æ–°å¯†ç " 
                                    class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button id="updateCredentialsBtn" class="mt-3 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition">
                                æ›´æ–°ç™»å½•å‡­è¯
                            </button>
                        </div>

                        <!-- é…ç½®å¤‡ä»½ -->
                        <div class="mb-6">
                            <h4 class="text-md font-medium text-gray-300 mb-3">é…ç½®å¤‡ä»½</h4>
                            <div class="flex space-x-2">
                                <button id="exportConfigBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                                    å¯¼å‡ºé…ç½®
                                </button>
                                <button id="importConfigBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                    å¯¼å…¥é…ç½®
                                </button>
                            </div>
                            <input type="file" id="configFileInput" accept=".json" class="hidden">
                        </div>

                        <!-- ç³»ç»Ÿä¿¡æ¯ -->
                        <div>
                            <h4 class="text-md font-medium text-gray-300 mb-3">ç³»ç»Ÿä¿¡æ¯</h4>
                            <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">ç‰ˆæœ¬:</span>
                                        <span class="text-white ml-2">v1.0.0</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">å½“å‰ç”¨æˆ·:</span>
                                        <span id="currentUser" class="text-white ml-2">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">é…ç½®æ•°é‡:</span>
                                        <span id="configCount" class="text-white ml-2">0</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">æœ€åæ›´æ–°:</span>
                                        <span id="lastUpdate" class="text-white ml-2">æš‚æœªæ›´æ–°</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div id="statusMessage" class="hidden fixed top-4 right-4 z-50 p-4 rounded-lg border shadow-lg fade-in"></div>

    <script>
        // === å…¨å±€é…ç½®ç®¡ç† ===
        class ConfigManager {
            constructor() {
                this.loadFromServer();
            }

            async loadFromServer() {
                try {
                    // ä»æœåŠ¡å™¨è·å–å½“å‰é…ç½®
                    const response = await fetch('/api/admin-config');
                    if (response.ok) {
                        const config = await response.json();
                        this.serverConfig = config;
                        this.images = config.gallery_images || [];
                        this.apis = config.api_configs || [];
                        this.prompts = config.prompts || [];
                        this.credentials = config.admin_credentials || { username: 'admin', password: 'admin' };
                        console.log('âœ… é…ç½®åŠ è½½æˆåŠŸï¼Œå½“å‰ç”¨æˆ·:', this.credentials.username);
                    } else {
                        throw new Error('è·å–é…ç½®å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                    // ä½¿ç”¨æœ¬åœ°ç¼“å­˜ä½œä¸ºé™çº§æ–¹æ¡ˆ
                    this.loadFromLocal();
                }
            }

            loadFromLocal() {
                this.images = JSON.parse(localStorage.getItem('adminImages') || '[]');
                this.apis = JSON.parse(localStorage.getItem('adminApis') || '[]');
                this.prompts = JSON.parse(localStorage.getItem('adminPrompts') || '[]');
                this.credentials = JSON.parse(localStorage.getItem('adminCredentials') || '{"username":"admin","password":"admin"}');
            }

            // å…³é”®ä¿®å¤ï¼šä¿å­˜é…ç½®æ—¶ä¼ å…¥å½“å‰æ­£ç¡®çš„å‡­è¯ç”¨äºéªŒè¯
            async saveToServer() {
                try {
                    console.log('ğŸ”„ å¼€å§‹ä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨...');
                    console.log('ğŸ”‘ ä½¿ç”¨å½“å‰å‡­è¯è¿›è¡ŒéªŒè¯:', this.credentials.username);
                    
                    const config = {
                        gallery_images: this.images,
                        api_configs: this.apis,
                        prompts: this.prompts,
                        admin_credentials: this.credentials
                    };

                    const response = await fetch('/api/admin-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: this.credentials.username, // ä½¿ç”¨å½“å‰å­˜å‚¨çš„å‡­è¯éªŒè¯
                            password: this.credentials.password, // ä½¿ç”¨å½“å‰å­˜å‚¨çš„å‡­è¯éªŒè¯
                            config: config
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… æœåŠ¡å™¨ä¿å­˜ç»“æœ:', result);
                        return result.success;
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'æœªçŸ¥é”™è¯¯' }));
                        console.error('âŒ æœåŠ¡å™¨ä¿å­˜å¤±è´¥:', response.status, errorData);
                        throw new Error(`ä¿å­˜å¤±è´¥: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
                    return false;
                }
            }

            saveToBrowser() {
                localStorage.setItem('adminImages', JSON.stringify(this.images));
                localStorage.setItem('adminApis', JSON.stringify(this.apis));
                localStorage.setItem('adminPrompts', JSON.stringify(this.prompts));
                localStorage.setItem('adminCredentials', JSON.stringify(this.credentials));
            }

            exportConfig() {
                const config = {
                    images: this.images,
                    apis: this.apis,
                    prompts: this.prompts,
                    credentials: this.credentials,
                    exportTime: new Date().toISOString()
                };
                return JSON.stringify(config, null, 2);
            }

            importConfig(configJson) {
                try {
                    const config = JSON.parse(configJson);
                    this.images = config.images || [];
                    this.apis = config.apis || [];
                    this.prompts = config.prompts || [];
                    this.credentials = config.credentials || { username: 'admin', password: 'admin' };
                    return true;
                } catch (error) {
                    console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
                    return false;
                }
            }
        }

        // === åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨ ===
        const configManager = new ConfigManager();
        let isAuthenticated = false;

        // === DOM å…ƒç´  ===
        const loginContainer = document.getElementById('loginContainer');
        const adminContainer = document.getElementById('adminContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const defaultWarning = document.getElementById('defaultWarning');
        const statusMessage = document.getElementById('statusMessage');
        const currentUser = document.getElementById('currentUser');
        const currentCredentials = document.getElementById('currentCredentials');
        const configCount = document.getElementById('configCount');
        const lastUpdate = document.getElementById('lastUpdate');

        // === è®¤è¯åŠŸèƒ½ ===
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            // éªŒè¯å‡­æ®
            if (configManager.credentials && 
                username === configManager.credentials.username && 
                password === configManager.credentials.password) {
                
                isAuthenticated = true;
                currentUser.textContent = `${configManager.credentials.username}`;
                currentCredentials.textContent = `${configManager.credentials.username}@admin`;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å‡­è¯
                if (username === 'admin' && password === 'admin') {
                    defaultWarning.classList.remove('hidden');
                    loginError.classList.add('hidden');
                } else {
                    defaultWarning.classList.add('hidden');
                    loginError.classList.add('hidden');
                }
                
                // åˆ‡æ¢ç•Œé¢
                loginContainer.classList.add('hidden');
                adminContainer.classList.remove('hidden');
                
                // åˆå§‹åŒ–ç®¡ç†ç•Œé¢
                await initializeAdminUI();
                
                showStatus('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                loginError.textContent = `ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\nå½“å‰:${configManager.credentials.username}/${configManager.credentials.password}`;
                loginError.classList.remove('hidden');
                defaultWarning.classList.add('hidden');
                showStatus('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡­æ®', 'error');
            }
        });

        // === é€€å‡ºç™»å½• ===
        document.getElementById('logoutBtn').addEventListener('click', function() {
            isAuthenticated = false;
            adminContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            
            // æ¸…ç©ºè¡¨å•
            loginForm.reset();
            loginError.classList.add('hidden');
            defaultWarning.classList.add('hidden');
            
            showStatus('å·²å®‰å…¨é€€å‡ºç™»å½•', 'info');
        });

        // === æ ‡ç­¾é¡µåˆ‡æ¢ ===
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('tab-active');
                    b.classList.add('bg-gray-800', 'text-gray-300', 'hover:bg-gray-700');
                });
                this.classList.add('tab-active');
                this.classList.remove('bg-gray-800', 'text-gray-300', 'hover:bg-gray-700');
                
                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(targetTab + 'Tab').classList.remove('hidden');
            });
        });

        // === åˆå§‹åŒ–ç®¡ç†ç•Œé¢ ===
        async function initializeAdminUI() {
            try {
                await configManager.loadFromServer();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
            
            renderImageList();
            renderApiList();
            renderPromptList();
            updateSystemInfo();
        }

        // === å›¾ç‰‡ç®¡ç†åŠŸèƒ½ ===
        document.getElementById('addImageBtn').addEventListener('click', async function() {
            const input = document.getElementById('newImageUrl');
            const url = input.value.trim();
            
            if (!url) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡ç½‘å€', 'error');
                return;
            }

            if (!url.startsWith('https://') && !url.startsWith('http://')) {
                showStatus('è¯·è¾“å…¥ä»¥ http:// æˆ– https:// å¼€å¤´çš„å®Œæ•´ç½‘å€', 'error');
                return;
            }

            if (configManager.images.includes(url)) {
                showStatus('è¯¥å›¾ç‰‡å·²å­˜åœ¨äºåˆ—è¡¨ä¸­', 'warning');
                return;
            }

            configManager.images.push(url);
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨å’Œæµè§ˆå™¨
            const serverSaveSuccess = await configManager.saveToServer();
            configManager.saveToBrowser();
            
            if (serverSaveSuccess) {
                input.value = '';
                renderImageList();
                updateSystemInfo();
                showStatus('å›¾ç‰‡æ·»åŠ æˆåŠŸå¹¶å·²ä¿å­˜', 'success');
            } else {
                showStatus('å›¾ç‰‡å·²æ·»åŠ ï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'warning');
            }
        });

        function renderImageList() {
            const imageList = document.getElementById('imageList');
            
            if (configManager.images.length === 0) {
                imageList.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— è‡ªå®šä¹‰å›¾ç‰‡ï¼Œè¯·æ·»åŠ ç¤ºä¾‹ä½œå“</p>';
                return;
            }

            imageList.innerHTML = configManager.images.map((url, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center flex-1">
                        <img src="${url}" alt="ç¤ºä¾‹å›¾ç‰‡" class="w-12 h-12 object-cover rounded mr-3 bg-gray-700">
                        <div class="flex-1">
                            <p class="text-white text-sm break-all">${url}</p>
                            <p class="text-gray-500 text-xs">ç¤ºä¾‹å›¾ç‰‡ #${index + 1}</p>
                        </div>
                    </div>
                    <button onclick="removeImage(${index})" class="text-red-400 hover:text-red-300 ml-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function removeImage(index) {
            configManager.images.splice(index, 1);
            
            const serverSaveSuccess = await configManager.saveToServer();
            configManager.saveToBrowser();
            
            renderImageList();
            updateSystemInfo();
            
            if (serverSaveSuccess) {
                showStatus('å›¾ç‰‡å·²ç§»é™¤å¹¶ä¿å­˜', 'info');
            } else {
                showStatus('å›¾ç‰‡å·²ç§»é™¤ï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥', 'warning');
            }
        }

        // === APIé…ç½®åŠŸèƒ½ ===
        function renderApiList() {
            // APIåˆ—è¡¨æ¸²æŸ“ï¼ˆç›®å‰åªæ˜¯ç¯å¢ƒå˜é‡é…ç½®ï¼‰
            const apiList = document.getElementById('apiList');
            if (apiList) {
                apiList.innerHTML = `
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-white flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                ç¯å¢ƒå˜é‡ API (é»˜è®¤)
                            </h4>
                            <span class="text-green-400 text-sm">âœ“ å¯ç”¨</span>
                        </div>
                        <p class="text-gray-400 text-sm">ä½¿ç”¨ Cloudflare Pages ç¯å¢ƒå˜é‡é…ç½®çš„ API å¯†é’¥</p>
                    </div>
                `;
            }
        }

        // === æç¤ºè¯ç®¡ç†åŠŸèƒ½ ===
        document.getElementById('addPromptBtn').addEventListener('click', async function() {
            const name = document.getElementById('promptName').value.trim();
            const key = document.getElementById('promptKey').value.trim();
            const content = document.getElementById('promptContent').value.trim();
            
            if (!name || !key) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æç¤ºè¯åç§°å’Œé”®å€¼', 'error');
                return;
            }

            // æ£€æŸ¥é”®å€¼æ˜¯å¦å·²å­˜åœ¨
            if (configManager.prompts.find(p => p.key === key)) {
                showStatus('è¯¥æç¤ºè¯é”®å€¼å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–é”®å€¼', 'warning');
                return;
            }

            // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
            if (configManager.prompts.find(p => p.name === name)) {
                showStatus('è¯¥æç¤ºè¯åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°', 'warning');
                return;
            }

            const newPrompt = {
                name: name,
                key: key,
                prompt: content // å®Œæ•´æç¤ºè¯å†…å®¹ï¼Œå¯ä»¥ä¸ºç©ºä½¿ç”¨å†…ç½®æ¨¡æ¿
            };

            configManager.prompts.push(newPrompt);
            
            const serverSaveSuccess = await configManager.saveToServer();
            configManager.saveToBrowser();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('promptName').value = '';
            document.getElementById('promptKey').value = '';
            document.getElementById('promptContent').value = '';
            
            renderPromptList();
            updateSystemInfo();
            
            if (serverSaveSuccess) {
                showStatus('æç¤ºè¯æ·»åŠ æˆåŠŸå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨', 'success');
            } else {
                showStatus('æç¤ºè¯å·²æ·»åŠ ï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥', 'warning');
            }
        });

        function renderPromptList() {
            const promptList = document.getElementById('promptList');
            
            promptList.innerHTML = configManager.prompts.map((prompt, index) => `
                <div class="flex items-start justify-between p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex-1">
                        <h4 class="text-white font-medium flex items-center">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                            ${prompt.name}
                        </h4>
                        <p class="text-gray-500 text-sm">é”®å€¼: ${prompt.key}</p>
                        ${prompt.prompt ? `<p class="text-gray-400 text-xs mt-1 truncate">${prompt.prompt.substring(0, 100)}${prompt.prompt.length > 100 ? '...' : ''}</p>` : '<p class="text-gray-400 text-xs">ä½¿ç”¨å†…ç½®æ¨¡æ¿</p>'}
                        <span class="text-yellow-400 text-xs">è‡ªå®šä¹‰é£æ ¼</span>
                    </div>
                    <button onclick="removePrompt(${index})" class="text-red-400 hover:text-red-300 ml-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function removePrompt(index) {
            configManager.prompts.splice(index, 1);
            
            const serverSaveSuccess = await configManager.saveToServer();
            configManager.saveToBrowser();
            
            renderPromptList();
            updateSystemInfo();
            
            if (serverSaveSuccess) {
                showStatus('æç¤ºè¯å·²ç§»é™¤å¹¶ä¿å­˜', 'info');
            } else {
                showStatus('æç¤ºè¯å·²ç§»é™¤ï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥', 'warning');
            }
        }

        // === åŸºç¡€è®¾ç½®åŠŸèƒ½ - å…³é”®ä¿®å¤éƒ¨åˆ† ===
        document.getElementById('updateCredentialsBtn').addEventListener('click', async function() {
            console.log('ğŸ” å¼€å§‹æ›´æ–°ç™»å½•å‡­è¯...');
            
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            
            console.log('ğŸ“ è¾“å…¥çš„æ–°å‡­è¯:', { newUsername, hasPassword: !!newPassword });
            
            if (!newUsername || !newPassword) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            if (newUsername.length < 3) {
                showStatus('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦', 'error');
                return;
            }

            if (newPassword.length < 4) {
                showStatus('å¯†ç è‡³å°‘éœ€è¦4ä¸ªå­—ç¬¦', 'error');
                return;
            }

            // ä¿å­˜æ—§å‡­è¯ç”¨äºéªŒè¯
            const oldCredentials = { ...configManager.credentials };
            console.log('ğŸ”‘ å½“å‰ç”¨äºéªŒè¯çš„å‡­è¯:', oldCredentials.username);

            // ä¸´æ—¶ä¿å­˜æ–°å‡­è¯åˆ°å†…å­˜
            const newCredentials = { username: newUsername, password: newPassword };
            
            try {
                console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨å½“å‰å‡­è¯éªŒè¯å¹¶ä¿å­˜æ–°é…ç½®...');
                
                // æ›´æ–°é…ç½®ä¸­çš„å‡­è¯
                const configToSave = {
                    gallery_images: configManager.images,
                    api_configs: configManager.apis,
                    prompts: configManager.prompts,
                    admin_credentials: newCredentials  // ä½¿ç”¨æ–°å‡­è¯
                };
                
                const response = await fetch('/api/admin-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: oldCredentials.username, // ä½¿ç”¨å½“å‰å‡­è¯è¿›è¡ŒéªŒè¯
                        password: oldCredentials.password, // ä½¿ç”¨å½“å‰å‡­è¯è¿›è¡ŒéªŒè¯
                        config: configToSave
                    })
                });

                console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… æœåŠ¡å™¨ä¿å­˜ç»“æœ:', result);
                    
                    if (result.success) {
                        // æ›´æ–°å†…å­˜ä¸­çš„å‡­è¯
                        configManager.credentials = newCredentials;
                        configManager.saveToBrowser();
                        
                        // æ›´æ–°UIæ˜¾ç¤º
                        currentUser.textContent = newUsername;
                        currentCredentials.textContent = `${newUsername}@admin`;
                        
                        // æ¸…ç©ºè¡¨å•
                        document.getElementById('newUsername').value = '';
                        document.getElementById('newPassword').value = '';
                        
                        showStatus('ç™»å½•å‡­è¯æ›´æ–°æˆåŠŸï¼è¯·ä½¿ç”¨æ–°å‡­è¯é‡æ–°ç™»å½•', 'success');
                        
                        // å»¶è¿Ÿ2ç§’åè‡ªåŠ¨é€€å‡ºç™»å½•
                        setTimeout(() => {
                            isAuthenticated = false;
                            adminContainer.classList.add('hidden');
                            loginContainer.classList.remove('hidden');
                            loginForm.reset();
                            loginError.classList.add('hidden');
                            defaultWarning.classList.add('hidden');
                            showStatus('è¯·ä½¿ç”¨æ–°å‡­æ®é‡æ–°ç™»å½•', 'info');
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'æœªçŸ¥é”™è¯¯' }));
                    console.error('âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('âŒ å‡­è¯æ›´æ–°å¤±è´¥:', error);
                // ä¸å›æ»šå‡­è¯ï¼Œä¿æŒåœ¨å†…å­˜ä¸­çš„é…ç½®çŠ¶æ€
                showStatus(`å‡­è¯æ›´æ–°å¤±è´¥: ${error.message}ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`, 'error');
            }
        });

        // === é…ç½®å¤‡ä»½åŠŸèƒ½ ===
        document.getElementById('exportConfigBtn').addEventListener('click', function() {
            const configJson = configManager.exportConfig();
            const blob = new Blob([configJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-chalkboard-config-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showStatus('é…ç½®å·²å¯¼å‡º', 'success');
        });

        document.getElementById('importConfigBtn').addEventListener('click', function() {
            document.getElementById('configFileInput').click();
        });

        document.getElementById('configFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const configJson = event.target.result;
                
                if (configManager.importConfig(configJson)) {
                    const serverSaveSuccess = await configManager.saveToServer();
                    configManager.saveToBrowser();
                    
                    renderImageList();
                    renderApiList();
                    renderPromptList();
                    updateSystemInfo();
                    
                    if (serverSaveSuccess) {
                        showStatus('é…ç½®å¯¼å…¥æˆåŠŸå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨', 'success');
                    } else {
                        showStatus('é…ç½®å¯¼å…¥æˆåŠŸï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥', 'warning');
                    }
                } else {
                    showStatus('é…ç½®å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; // æ¸…ç©ºinputä»¥ä¾¿é‡å¤é€‰æ‹©
        });

        // === å·¥å…·å‡½æ•° ===
        function updateSystemInfo() {
            const totalConfigs = configManager.images.length + configManager.prompts.length;
            configCount.textContent = totalConfigs.toString();
            
            const lastUpdate = localStorage.getItem('lastConfigUpdate');
            if (lastUpdate) {
                document.getElementById('lastUpdate').textContent = new Date(lastUpdate).toLocaleString();
            } else {
                document.getElementById('lastUpdate').textContent = 'æš‚æœªæ›´æ–°';
            }
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            localStorage.setItem('lastConfigUpdate', new Date().toISOString());
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg border shadow-lg fade-in';
            
            switch(type) {
                case 'success':
                    statusMessage.classList.add('bg-green-900/90', 'text-green-200', 'border-green-800/50');
                    break;
                case 'error':
                    statusMessage.classList.add('bg-red-900/90', 'text-red-200', 'border-red-800/50');
                    break;
                case 'warning':
                    statusMessage.classList.add('bg-yellow-900/90', 'text-yellow-200', 'border-yellow-800/50');
                    break;
                default:
                    statusMessage.classList.add('bg-blue-900/90', 'text-blue-200', 'border-blue-800/50');
            }
            
            statusMessage.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // === é¡µé¢åŠ è½½å®Œæˆå ===
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤ç”¨æˆ·åæç¤º
            document.getElementById('username').placeholder = 'è¯·è¾“å…¥ç”¨æˆ·å';
            document.getElementById('password').placeholder = 'è¯·è¾“å…¥å¯†ç ';
        });

        // === é”®ç›˜å¿«æ·é”®æ”¯æŒ ===
        document.addEventListener('keydown', function(e) {
            // åœ¨ç™»å½•ç•Œé¢æ”¯æŒEnteré”®æäº¤
            if (!isAuthenticated && e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'INPUT' && activeElement.form === loginForm) {
                    loginForm.dispatchEvent(new Event('submit'));
                }
            }
            // ESCé”®å…³é—­çŠ¶æ€æç¤º
            if (e.key === 'Escape' && !statusMessage.classList.contains('hidden')) {
                statusMessage.classList.add('hidden');
            }
        });
    </script>
</body>
</html>